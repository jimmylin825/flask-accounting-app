âœ… ç¬¬å››æ­¥ï¼šç™»å‡ºåŠŸèƒ½èˆ‡ç™»å…¥ä¿è­·é é¢
æœ¬éšæ®µç›®æ¨™ï¼š

    å¯¦ä½œ /logout ç™»å‡ºåŠŸèƒ½

    ä½¿ç”¨ @login_required ä¿è­·æŸäº›é é¢ï¼ˆä¾‹å¦‚ï¼šè¨˜å¸³é¦–é åªèƒ½ç™»å…¥å¾Œçœ‹ï¼‰

    é…åˆ current_user å–å¾—ç›®å‰ç™»å…¥è€…è³‡æ–™

âœ… 1. å¯¦ä½œ /logout ç™»å‡ºåŠŸèƒ½
ğŸ”§ åœ¨ auth.py ä¸­æ–°å¢ï¼š

from flask_login import logout_user, login_required

@auth_bp.route("/logout")
@login_required
def logout():
    logout_user()
    flash("æ‚¨å·²æˆåŠŸç™»å‡º")
    return redirect(url_for("auth.login"))

âœ… 2. è¨­å®šé¦–é  / éœ€è¦ç™»å…¥æ‰èƒ½æŸ¥çœ‹
ğŸ›  ä¿®æ”¹ä½ çš„ app.pyï¼š

from flask_login import login_required, current_user

@app.route("/")
@login_required
def home():
    return f"æ­¡è¿ï¼Œ{current_user.username}ï¼"

é€™æ¨£å°±å®Œæˆäº†ç™»å…¥ä¿è­·é é¢ï¼š

    å¦‚æœæœªç™»å…¥è¨ªå• /ï¼Œæœƒè‡ªå‹•è¢«å°å‘åˆ° /login

    æˆåŠŸç™»å…¥å¾Œæ‰æœƒçœ‹åˆ°ã€Œæ­¡è¿ï¼ŒXXXã€

âœ… å°æé†’ï¼šlogin_view å¿…é ˆæ­£ç¢º

ä½ åœ¨ app.py æ‡‰è©²å·²ç¶“è¨­å®šéé€™è¡Œï¼š

login_manager.login_view = 'auth.login'

é€™æ¨£ Flask-Login æ‰çŸ¥é“ã€Œæœªç™»å…¥è¦å°å‘å“ªå€‹é é¢ã€ã€‚
âœ… 3. ä½¿ç”¨ current_user å–å¾—ç™»å…¥è€…è³‡æ–™

ä½ å¯ä»¥åœ¨ä»»ä½•é é¢ä¸­ä½¿ç”¨ï¼š

from flask_login import current_user

print(current_user.id)         # ä½¿ç”¨è€… ID
print(current_user.username)   # ä½¿ç”¨è€…å¸³è™Ÿ

Flask-Login å¹«ä½ è‡ªå‹•ç®¡ç†ç™»å…¥è€…ç‹€æ…‹ã€‚
æ¸¬è©¦å»ºè­°ï¼š

    è¨»å†Š â†’ ç™»å…¥ â†’ é é¢é¡¯ç¤ºæ­¡è¿è¨Šæ¯

    æŒ‰ç¶²å€è¼¸å…¥ /logout â†’ è‡ªå‹•ç™»å‡º â†’ è¢«å°å‘ /login

    ç™»å‡ºç‹€æ…‹ä¸‹æ‰“é–‹ / â†’ è‡ªå‹•è¢«å°å‘ /login

âœ… ç¬¬ä¸€é¡Œï¼šé¦–é æ‡‰è©²é¡¯ç¤ºä»€éº¼ï¼Ÿæ˜¯å¦æ”¹ç‚º /expenses æ¯”è¼ƒå¥½ï¼Ÿ
âœ” å»ºè­°åšæ³•ï¼š

ä½ å¯ä»¥æŠŠç¾åœ¨çš„ / é é¢æ”¹ç‚ºï¼š

    å°å‘ä¸»è¦åŠŸèƒ½é é¢ï¼ˆä¾‹å¦‚ï¼š/expensesï¼‰

    æˆ–æ˜¯é¡¯ç¤ºç™»å…¥è€…çš„åŸºæœ¬è³‡è¨Šèˆ‡å¿«é€Ÿå…¥å£

âœ¨ å¦‚æœä½ çš„è¨˜å¸³åŠŸèƒ½æ˜¯åœ¨ /expensesï¼š

é‚£éº¼ä½ å¯ä»¥é€™æ¨£è¨­è¨ˆï¼š

@app.route("/")
@login_required
def home():
    return redirect(url_for("expenses.index"))  # æˆ–ä½ è‡ªå·±çš„è—åœ–åç¨±èˆ‡å‡½å¼

æˆ–è€…ä½ ä¹Ÿå¯ä»¥æŠŠ /expenses è¨­ç‚ºä½ çš„ã€Œè¨˜å¸³ä¸»ç•«é¢ã€ï¼Œè€Œ / åƒ…ç‚ºé¸å–®æˆ–å°è¦½é ã€‚
ğŸ§  çµè«–ï¼š

é¦–é ï¼ˆ/ï¼‰è¦ä¸è¦ç”¨ï¼Œå–æ±ºæ–¼ä½ ä½œå“çš„åŠŸèƒ½æµç¨‹ï¼Œä½ å¯ä»¥å…ˆä¿ç•™ / ä½œç‚ºç™»å…¥æ¸¬è©¦ç”¨ã€ä¹‹å¾Œå†æ±ºå®šè¦ä¸è¦æ”¹æˆ /expenses é è¨­é é¢ã€‚
âœ… ç¬¬äºŒé¡Œï¼šcurrent_user.id ç­‰ç”¨æ³•æ˜¯åšä»€éº¼ç”¨çš„ï¼Ÿ

é€™æ˜¯éå¸¸é—œéµçš„è§€å¿µï¼Œè®“æˆ‘å¹«ä½ æ¸…æ¥šé‡æ¸…ç”¨é€”ï¼š
ğŸ”¹ èªªæ³•ï¼šã€Œåœ¨ä»»ä½•é é¢ä¸­ä½¿ç”¨ã€

æ„æ€æ˜¯ï¼šåªè¦æ˜¯è™•ç†ä½¿ç”¨è€…è³‡æ–™çš„ Flask è·¯ç”±ã€æ¨¡æ¿æˆ–å¾Œå°é‚è¼¯ä¸­ï¼Œéƒ½å¯ä»¥ä½¿ç”¨ current_user ä¾†ä»£è¡¨ã€Œç›®å‰ç™»å…¥çš„ä½¿ç”¨è€…ã€ã€‚
âœ… ç”¨é€”å¦‚ä¸‹ï¼š
ä½¿ç”¨æƒ…å¢ƒ	ç”¨æ³•	èªªæ˜
å¾Œç«¯æŸ¥è³‡æ–™	current_user.id	æ‹¿ä¾†æŸ¥è©¢é€™å€‹ä½¿ç”¨è€…çš„è³‡æ–™
æŸ¥å€‹äººèŠ±è²»	session.query(...).filter_by(user_id=current_user.id)	é¿å…çœ‹åˆ°åˆ¥äººçš„è³‡æ–™
æ¨¡æ¿é¡¯ç¤ºåç¨±	{{ current_user.username }}	åœ¨ HTML é¡¯ç¤ºæ­¡è¿è¨Šæ¯
é–‹ç™¼é™¤éŒ¯	print(current_user)	ä½ åœ¨é–‹ç™¼éšæ®µå°å‡ºç™»å…¥è€…è³‡æ–™çœ‹æ˜¯å¦æ­£ç¢º
ğŸ§  ç™½è©±ç¸½çµï¼š

    current_user æ˜¯ Flask-Login å¹«ä½ å»ºç«‹çš„ç™»å…¥è€…ç‰©ä»¶

    å¾Œç«¯æ§åˆ¶æ¬Šé™ã€å‰ç«¯é¡¯ç¤ºåå­—ã€è³‡æ–™æŸ¥è©¢éš”é›¢ éƒ½æœƒç”¨åˆ°

    print(current_user) æ˜¯ä½ é–‹ç™¼é™¤éŒ¯æ™‚çœ‹çš„ï¼Œä¸æ˜¯çµ¦ä½¿ç”¨è€…çœ‹

ğŸ”§ é–‹ç™¼å°æç¤ºï¼š

ä½ å¯ä»¥æš«æ™‚åœ¨ / å¯«é€™æ¨£çš„æ¸¬è©¦å…§å®¹ä¾†è§€å¯Ÿï¼š

@app.route("/")
@login_required
def home():
    return f"ç›®å‰ç™»å…¥è€… IDï¼š{current_user.id}<br>å¸³è™Ÿï¼š{current_user.username}"

é€™æ¨£ä½ èƒ½å¾ˆå¿«çŸ¥é“ç™»å…¥æˆåŠŸèˆ‡å¦ï¼Œæœªä¾†ä¹Ÿèƒ½æŠŠé€™äº›è³‡æ–™æ‹¿å»åšæ¢ä»¶éæ¿¾èˆ‡è³‡æ–™éš”é›¢ã€‚

ğŸ¯ æœ¬æ¬¡ç›®æ¨™ï¼šå¯¦ä½œ è³‡æ–™éš”é›¢åŠŸèƒ½

è®“æ¯ä½ä½¿ç”¨è€…åªèƒ½çœ‹åˆ°è‡ªå·±çš„è¨˜å¸³è³‡æ–™ã€‚
ğŸ§© æ­¥é©Ÿæ‹†è§£èˆ‡æ•™å­¸ï¼ˆä»¥åˆå­¸è€…è§’åº¦ï¼‰
ğŸ”§ æ­¥é©Ÿ 1ï¼šåœ¨ Expense è³‡æ–™è¡¨ä¸­åŠ å…¥ user_id æ¬„ä½

ä½ è¦è®“æ¯ä¸€ç­†æ”¶æ”¯è³‡æ–™éƒ½ã€Œå±¬æ–¼æŸä½ä½¿ç”¨è€…ã€ï¼Œæ‰€ä»¥å¿…é ˆåœ¨æ¨¡å‹è£¡åŠ ä¸Šï¼š

from sqlalchemy import Column, Integer, ForeignKey
from flask_login import UserMixin

class Expense(Base):
    __tablename__ = "expense"
    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("user.id"), nullable=False)  # ğŸ”ºåŠ é€™è¡Œ
    ...

é€™æ¨£æ¯ç­†è³‡æ–™å°±æœƒè¢«æ¨™è¨˜æ˜¯ã€Œå“ªä½ä½¿ç”¨è€…ã€å»ºç«‹çš„ã€‚
ğŸ§  å•é¡Œï¼šæˆ‘åŸæœ¬çš„è³‡æ–™åº«å·²ç¶“æœ‰è³‡æ–™äº†æ€éº¼è¾¦ï¼Ÿ

ä½ æœ‰å…©å€‹é¸æ“‡ï¼š

    ç”¨ Alembic å»º migrationï¼ˆé€²éšï¼‰

    æ‰‹å‹•åˆªé™¤ database.db ç„¶å¾Œé‡å»ºè¡¨æ ¼ï¼ˆå¿«é€Ÿç°¡å–®ï¼‰

å¦‚æœä½ é‚„åœ¨é–‹ç™¼éšæ®µï¼Œå»ºè­°ç›´æ¥åˆªæ‰ database.db æª”æ¡ˆï¼Œå†é‡æ–°åŸ·è¡Œ Base.metadata.create_all(engine) å°±å¥½ã€‚
ğŸ”§ æ­¥é©Ÿ 2ï¼šä¿®æ”¹ POST å„²å­˜è³‡æ–™æ™‚ï¼Œå°‡ç›®å‰ç™»å…¥è€…çš„ user_id å­˜é€²è³‡æ–™åº«

ä½ ç›®å‰çš„ç¨‹å¼ç¢¼ï¼š

new_expense = Expense(category=..., amount=..., ...)

è«‹æ”¹ç‚ºï¼š

from flask_login import current_user

new_expense = Expense(
    user_id=current_user.id,   # ğŸ”ºæ–°å¢é€™è¡Œ
    category=category,
    amount=int(amount),
    type=type_,
    date=date_obj,
    note=note
)

é€™æ¨£å„²å­˜é€²ä¾†çš„è³‡æ–™æœƒæ¨™ä¸Šé€™æ˜¯èª°çš„ç´€éŒ„ã€‚
ğŸ”§ æ­¥é©Ÿ 3ï¼šæŸ¥è©¢è³‡æ–™æ™‚ï¼Œåªæ’ˆå‡ºå±¬æ–¼ç•¶å‰ä½¿ç”¨è€…çš„è³‡æ–™

ä½ çš„ç¨‹å¼ç¢¼ç›®å‰æ˜¯ï¼š

params = get_query_parameters()
records = filtered_query(**params)

è«‹ç¢ºèª filtered_query æ”¯æ´æ¢ä»¶éæ¿¾ï¼Œæˆ–ç›´æ¥æ‰‹å‹•åŠ ä¸Šï¼š

from flask_login import current_user

params = get_query_parameters()
params["user_id"] = current_user.id  # ğŸ”º åŠ å…¥æ¢ä»¶
records = filtered_query(**params)

å¦‚æœ filtered_query() æ˜¯ä½ è‡ªå·±å¯«çš„å‡½å¼ï¼Œä½ éœ€è¦åœ¨è£¡é¢ä¹ŸåŠ å…¥å° user_id çš„ .filter()ï¼Œæˆ‘å¯ä»¥å¹«ä½ æ”¹ã€‚
ğŸ”§ æ­¥é©Ÿ 4ï¼šåœ¨ expenses.html ä¸­ç„¡éœ€è®Šæ›´

ç›®å‰ä½ æ˜¯é€éè¿´åœˆï¼š

{% for expense in expenses %}

åªè¦å¾Œç«¯æœ‰æ­£ç¢ºå‚³é€²ä¾†ã€Œå±¬æ–¼è‡ªå·±çš„è³‡æ–™ã€ï¼Œå‰ç«¯å°±æœƒæ­£ç¢ºé¡¯ç¤ºã€‚
âœï¸ å°çµæ•™å­¸å›é¡§ï¼š
å‹•ä½œ	åŸå› 
è³‡æ–™è¡¨åŠ  user_id æ¬„ä½	è¨˜éŒ„é€™ç­†è³‡æ–™æ˜¯èª°çš„
å»ºç«‹è³‡æ–™æ™‚åŠ å…¥ user_id	ç¶å®šä½¿ç”¨è€…èº«åˆ†
æŸ¥è³‡æ–™æ™‚éæ¿¾ user_id	é¿å…çœ‹åˆ°åˆ¥äººè³‡æ–™
ä¸éœ€æ”¹å‰ç«¯	è³‡æ–™æ­£ç¢ºå¾Œï¼Œè‡ªç„¶åªæœƒé¡¯ç¤ºè©²ç”¨æˆ¶è³‡æ–™