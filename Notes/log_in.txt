âœ… ç¬¬ä¸€æ­¥ï¼šå®‰è£å¥—ä»¶èˆ‡åŸºæœ¬åˆå§‹åŒ–
ğŸ“¦ å®‰è£éœ€è¦çš„å¥—ä»¶

è«‹åœ¨ä½ çš„è™›æ“¬ç’°å¢ƒä¸­å®‰è£ä»¥ä¸‹å…©å€‹å¥—ä»¶ï¼š

pip install flask-login flask-bcrypt

    flask-login: è™•ç†ä½¿ç”¨è€…ç™»å…¥ç‹€æ…‹ç®¡ç†

    flask-bcrypt: è™•ç†å¯†ç¢¼åŠ å¯†èˆ‡é©—è­‰

ğŸ“ å°ˆæ¡ˆæ¶æ§‹ï¼ˆå‡è¨­ä½ ä½¿ç”¨çš„æ˜¯ä»¥ä¸‹çµæ§‹ï¼‰ï¼š

your_project/
â”‚
â”œâ”€â”€ app.py
â”œâ”€â”€ models.py
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ auth.py        â† æˆ‘å€‘æœƒæ–°å¢é€™å€‹æª”æ¡ˆ
â”‚
â”œâ”€â”€ templates/
â”‚   â”œâ”€â”€ login.html
â”‚   â”œâ”€â”€ register.html
â”‚
â”œâ”€â”€ utils.py
â””â”€â”€ ...

ğŸ§  åœ¨ models.py ä¸­æ–°å¢ä½¿ç”¨è€…æ¨¡å‹

âœï¸ ä¿®æ”¹ç¯„ä¾‹ï¼ˆåŠ å…¥ User æ¨¡å‹ï¼‰

class User(Base, UserMixin):
    __tablename__ = "user"
    id = Column(Integer, primary_key=True)
    username = Column(String(100), unique=True, nullable=False)
    password_hash = Column(String(200), nullable=False)



âœ… app.pyï¼ˆæ•´åˆå¾Œç¯„ä¾‹ï¼‰

from flask import Flask
from flask_login import LoginManager
from routes import register_routes
from models import User, Session  # å¾ models åŒ¯å…¥ User æ¨¡å‹èˆ‡ Session å·¥å» 

app = Flask(__name__)
app.config['SECRET_KEY'] = 'your-secret-key'
# ç”¨æ–¼ session åŠ å¯†ï¼Œæ˜¯ Flask-Login ç®¡ç†ç™»å…¥ç‹€æ…‹æ‰€å¿…éœ€çš„ï¼ˆå¯è¨­ç‚ºä»»æ„é•·å­—ä¸²ï¼‰

# åˆå§‹åŒ– LoginManagerï¼Œè®“ Flask-Login èƒ½ç®¡ç†ä½¿ç”¨è€…ç™»å…¥ç‹€æ…‹
login_manager = LoginManager()
login_manager.login_view = 'auth.login'
# æŒ‡å®šæœªç™»å…¥ä½¿ç”¨è€…å¦‚æœè¨ªå•éœ€è¦ç™»å…¥çš„é é¢æ™‚ï¼Œè‡ªå‹•å°å‘çš„ endpoint åç¨±ï¼ˆå¾Œé¢æˆ‘å€‘æœƒåœ¨ routes/auth.py ä¸­å¯¦ä½œ `login`ï¼‰

login_manager.init_app(app)

# é€™å€‹å‡½å¼è®“ Flask-Login çŸ¥é“ã€Œå¦‚ä½•æ ¹æ“š user_id æ‰¾å‡ºå°æ‡‰çš„ä½¿ç”¨è€…ã€
# æ¯æ¬¡é é¢åˆ·æ–°ã€ç™»å…¥ç‹€æ…‹æª¢æŸ¥éƒ½æœƒè‡ªå‹•è§¸ç™¼
@login_manager.user_loader
def load_user(user_id):
    with Session() as session:
        return session.get(User, int(user_id))
        # é€™è£¡çš„ session æ˜¯ä½ è‡ªå·±å»ºç«‹çš„è³‡æ–™åº«æ“ä½œç’°å¢ƒ
        # session.get(User, id) æœƒå›å‚³ç¬¦åˆ id çš„ User ç‰©ä»¶ï¼Œæˆ–æ˜¯ None

# è¨»å†Šä½ æ‰€æœ‰ routesï¼ˆåŒ…å« auth ç™»å…¥/è¨»å†Šé é¢ã€è¨˜å¸³åŠŸèƒ½é é¢ç­‰ï¼‰
register_routes(app)

# æ¸¬è©¦ç”¨é¦–é 
@app.route("/")
def home():
    return "Home page"

ğŸ§  å°æé†’ï¼ˆç›®å‰ç‚ºæ­¢ä½ è¦ç†è§£çš„é‡é»ï¼‰ï¼š
å€å¡Š	é‡é»
SECRET_KEY	ä¿è­· sessionï¼Œè®“ç™»å…¥ç‹€æ…‹ä¸æœƒè¢«ç«„æ”¹
LoginManager	Flask-Login ç™»å…¥ç³»çµ±æ ¸å¿ƒå…ƒä»¶
login_view = 'auth.login'	æœªç™»å…¥æ™‚è·³è½‰çš„é é¢ï¼Œéœ€åœ¨ routes/auth.py ä¸­å®šç¾© login
@login_manager.user_loader	ç™»å…¥æ™‚æ ¹æ“š user_id å¾è³‡æ–™åº«æ’ˆå‡º User ç‰©ä»¶çµ¦ Flask-Login ä½¿ç”¨
with Session() as session:	æ¯æ¬¡è³‡æ–™åº«æ“ä½œé–‹ä¸€å€‹æ–°çš„å®‰å…¨ session å€å¡Šï¼ˆè‡ªå‹•é—œé–‰ï¼‰

ä½ å¯ä»¥èŠ±é»æ™‚é–“ç¢ºèªé€™æ®µæ˜¯å¦å®Œå…¨ç†è§£ï¼Œå¦‚æœæœ‰ä»»ä½•åœ°æ–¹ä¸æ¸…æ¥šæˆ‘å¯ä»¥é‡å°é‚£éƒ¨åˆ†è£œå……ã€‚

å¦‚æœé€™æ®µä½ å·²ç¶“ OKï¼Œä¸‹ä¸€æ­¥æˆ‘å€‘å°±é–‹å§‹é€²è¡Œï¼š

âœ… å»ºç«‹ routes/auth.py
âœ… è¨»å†Šè¡¨å–®é é¢ï¼ˆå«å¯†ç¢¼åŠ å¯†ï¼‰
âœ… å„²å­˜æ–°ç”¨æˆ¶é€²è³‡æ–™åº«

ç­‰ä½ èªªã€Œå¯ä»¥é–‹å§‹ä¸‹ä¸€æ­¥ã€ï¼Œæˆ‘å°±å¸¶ä½ é€²å…¥è¨»å†ŠåŠŸèƒ½çš„å¯¦ä½œï¼

æˆ‘å€‘ç¾åœ¨é€²å…¥ ä½¿ç”¨è€…è¨»å†ŠåŠŸèƒ½å¯¦ä½œã€‚é€™ä¸€éšæ®µæœƒåŒ…å«ä¸‰å€‹ä¸»è¦éƒ¨åˆ†ï¼š
ğŸ§© ç¬¬ä¸€æ­¥ï¼šå»ºç«‹ /register è·¯ç”±èˆ‡ HTML è¡¨å–®é¡¯ç¤º
âœ… 1. routes/auth.py å»ºç«‹åŸºæœ¬è¨»å†Šé‚è¼¯

å¦‚æœä½ é‚„æ²’æœ‰é€™å€‹æª”æ¡ˆï¼Œå…ˆå»ºç«‹ï¼š

your_project/
â””â”€â”€ routes/
    â””â”€â”€ auth.py

æ¥è‘—åœ¨ auth.py è£¡å¡«å…¥é€™æ®µåˆå§‹ç¢¼ï¼š

from flask import Blueprint, render_template, request, redirect, flash, url_for
from werkzeug.security import generate_password_hash
from models import Session, User
from flask_login import login_user

auth = Blueprint("auth", __name__)

@auth.route("/register", methods=["GET", "POST"])
def register():
    if request.method == "POST":
        username = request.form.get("username")
        password = request.form.get("password")

        # åŸºæœ¬æª¢æŸ¥
        if not username or not password:
            flash("è«‹è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼")
            return redirect(url_for("auth.register"))

        with Session() as session:
            existing_user = session.query(User).filter_by(username=username).first()
            if existing_user:
                flash("æ­¤å¸³è™Ÿå·²å­˜åœ¨")
                return redirect(url_for("auth.register"))

            # åŠ å¯†å¯†ç¢¼
            hashed_password = generate_password_hash(password)
            new_user = User(username=username, password_hash=hashed_password)
            session.add(new_user)
            session.commit()

            login_user(new_user)  # è¨»å†Šå®Œæˆç›´æ¥ç™»å…¥
            return redirect(url_for("home"))

    return render_template("register.html")

âœ… 2. templates/register.html å»ºç«‹è¨»å†Šè¡¨å–®

è«‹åœ¨ templates/ è³‡æ–™å¤¾ä¸­æ–°å¢ register.htmlï¼Œå…§å®¹å¦‚ä¸‹ï¼š

<!DOCTYPE html>
<html>
<head>
    <title>è¨»å†Š</title>
</head>
<body>
    <h2>è¨»å†Šå¸³è™Ÿ</h2>
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <ul>
          {% for msg in messages %}
            <li>{{ msg }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}
    <form method="POST">
        <label for="username">å¸³è™Ÿï¼š</label>
        <input type="text" name="username" required><br>
        <label for="password">å¯†ç¢¼ï¼š</label>
        <input type="password" name="password" required><br>
        <button type="submit">è¨»å†Š</button>
    </form>
</body>
</html>

âœ… 3. åœ¨ routes/__init__.py ä¸­è¨»å†Š auth blueprint

from .auth import auth

def register_routes(app):
    app.register_blueprint(auth)

âœ… 4. æ¸¬è©¦æµç¨‹

å•Ÿå‹• Flask å¾Œï¼Œè¨ªå• /register æ‡‰è©²æœƒçœ‹åˆ°è¡¨å–®ï¼Œæäº¤å¸³å¯†å¾Œæœƒï¼š

    æª¢æŸ¥å¸³è™Ÿæ˜¯å¦å·²å­˜åœ¨

    ä½¿ç”¨ werkzeug.security.generate_password_hash() é€²è¡ŒåŠ å¯†

    å¯«å…¥è³‡æ–™åº«

    æˆåŠŸå¾Œè‡ªå‹•ç™»å…¥ä¸¦è·³è½‰é¦–é 

ğŸ“Œ ç›®å‰ç‚ºæ­¢ä½ æ‡‰è©²å®Œæˆï¼š
åŠŸèƒ½	ç‹€æ…‹
/register é é¢	âœ… é¡¯ç¤ºæ­£å¸¸
è¡¨å–®é€å‡º	âœ… å„²å­˜æ–°ä½¿ç”¨è€…åˆ°è³‡æ–™åº«
å¯†ç¢¼åŠ å¯†	âœ… å·²è™•ç†
è¨»å†Šå¾Œè‡ªå‹•ç™»å…¥	âœ… æ­é… Flask-Login å·²å•Ÿç”¨

ä½ å¯ä»¥å…ˆç…§é€™éƒ¨åˆ†å®Œæˆèˆ‡æ¸¬è©¦ï¼Œæœ‰ä»»ä½•éŒ¯èª¤è¨Šæ¯æˆ‘å¯ä»¥å”åŠ©é™¤éŒ¯ã€‚å¦‚æœä½ å®Œæˆé€™ä¸€æ­¥æ²’å•é¡Œï¼Œä¸‹ä¸€æ­¥å°±æ˜¯ç™»å…¥åŠŸèƒ½ /login çš„å¯¦ä½œï¼Œæˆ‘å€‘å†ä¸€èµ·åšã€‚ä½ æº–å‚™å¥½å†å‘Šè¨´æˆ‘ï¼

ğŸ” ç™»å…¥åŠŸèƒ½å¯¦ä½œç›®æ¨™ï¼š

    é¡¯ç¤ºç™»å…¥è¡¨å–®ï¼ˆGETï¼‰

    ä½¿ç”¨è€…é€å‡ºå¸³å¯†å¾Œï¼ˆPOSTï¼‰æª¢æŸ¥å¸³è™Ÿæ˜¯å¦å­˜åœ¨

    æ¯”å°å¯†ç¢¼æ˜¯å¦æ­£ç¢ºï¼ˆä½¿ç”¨ check_password_hash()ï¼‰

    å¦‚æœæˆåŠŸå°±ç™»å…¥ä¸¦è·³è½‰ï¼›å¤±æ•—å‰‡ flash è¨Šæ¯ä¸¦è¿”å›è¡¨å–®

âœ… 1. ä¿®æ”¹ routes/auth.py åŠ å…¥ /login è·¯ç”±

åœ¨ä½ ç¾æœ‰çš„ auth.py ä¸­æ–°å¢ï¼š

from werkzeug.security import check_password_hash
from flask_login import login_user

@auth.route("/login", methods=["GET", "POST"])
def login():
    if request.method == "POST":
        username = request.form.get("username")
        password = request.form.get("password")

        if not username or not password:
            flash("è«‹è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼")
            return redirect(url_for("auth.login"))

        with Session() as session:
            user = session.query(User).filter_by(username=username).first()
            if not user or not check_password_hash(user.password_hash, password):
                flash("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤")
                return redirect(url_for("auth.login"))

            login_user(user)
            return redirect(url_for("home"))

    return render_template("login.html")

âœ… 2. å»ºç«‹ templates/login.html ç™»å…¥é é¢

åœ¨ templates/ è³‡æ–™å¤¾ä¸­æ–°å¢ login.htmlï¼š

<!DOCTYPE html>
<html>
<head>
    <title>ç™»å…¥</title>
</head>
<body>
    <h2>ç™»å…¥ç³»çµ±</h2>
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <ul>
          {% for msg in messages %}
            <li>{{ msg }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}
    <form method="POST">
        <label for="username">å¸³è™Ÿï¼š</label>
        <input type="text" name="username" required><br>
        <label for="password">å¯†ç¢¼ï¼š</label>
        <input type="password" name="password" required><br>
        <button type="submit">ç™»å…¥</button>
    </form>
</body>
</html>

âœ… 3. æ¸¬è©¦æµç¨‹

å•Ÿå‹•ä½ çš„ Flask å°ˆæ¡ˆï¼Œè¨ªå• /loginï¼š

    è¼¸å…¥ä¸€å€‹éŒ¯èª¤å¸³å¯†ï¼Œæ‡‰è©²æœƒå‡ºç¾éŒ¯èª¤æç¤ºï¼ˆflashï¼‰

    è¼¸å…¥æ­£ç¢ºå¸³å¯†ï¼Œæ‡‰è©²æœƒè·³è½‰åˆ° / ä¸¦ä¿æŒç™»å…¥ç‹€æ…‹

ğŸ§  ç™»å…¥æµç¨‹é‚è¼¯å›é¡§ï¼š
æ­¥é©Ÿ	èªªæ˜
ä½¿ç”¨è€…é€å‡ºå¸³å¯†	POST è¡¨å–®
æŸ¥æ‰¾è©²å¸³è™Ÿ	session.query(User)...
é©—è­‰å¯†ç¢¼	ç”¨ check_password_hash() å°æ¯”åŠ å¯†å¾Œå¯†ç¢¼
ç™»å…¥	login_user(user) æœƒåœ¨ç€è¦½å™¨è¨­ç½® cookieï¼Œä¿æŒç™»å…¥ç‹€æ…‹

ä½ å®Œæˆç™»å…¥åŠŸèƒ½ä¹‹å¾Œå‘Šè¨´æˆ‘ï¼Œæˆ‘å€‘å¯ä»¥æ¥è‘—å¯¦ä½œç™»å‡ºåŠŸèƒ½ logout()ï¼Œä»¥åŠå¦‚ä½•è®“æŸäº›é é¢ã€Œåªé™ç™»å…¥ä½¿ç”¨è€…ã€æ‰èƒ½ç€è¦½ï¼ˆä¿è­·å¸³å‹™è³‡æ–™ï¼‰ã€‚å®Œæˆå¾Œä¹Ÿå¯ä»¥é †ä¾¿åšè³‡æ–™éš”é›¢ï¼ä½ å…ˆå®Œæˆé€™éƒ¨åˆ†æˆ‘å†æ¥è‘—å¸¶ã€‚