ç›®æ¨™ï¼š åœ¨ /category-report é é¢å‘ˆç¾ã€Œå„é¡åˆ¥çš„æ”¶æ”¯çµ±è¨ˆã€ï¼Œä¸¦ç”¨åœ–è¡¨å±•ç¤ºï¼ˆåœ“é¤…åœ– or é•·æ¢åœ–ï¼‰
âœ… ç¬¬ä¸€æ­¥ï¼šæ–°å¢æŸ¥è©¢èˆ‡åˆ†æé‚è¼¯

è«‹ä½ å…ˆå®Œæˆä»¥ä¸‹å‹•ä½œï¼š

    åœ¨ report_service.py ä¸­æ–°å¢å‡½å¼ get_category_summary(records)ï¼š

        çµ±è¨ˆæ¯å€‹é¡åˆ¥çš„ã€Œæ”¶å…¥ç¸½å’Œã€èˆ‡ã€Œæ”¯å‡ºç¸½å’Œã€

        å›å‚³æ ¼å¼å¦‚ä¸‹ï¼š

        {
            "é¤é£²": {"income": 5000, "expense": 3200},
            "å¨›æ¨‚": {"income": 0, "expense": 2800},
            ...
        }

    æ¸¬è©¦æ–¹å¼ï¼š

        å¯ä»¥åœ¨ç¾æœ‰çš„ /summary è·¯ç”±ä¸­è‡¨æ™‚åŠ å…¥é€™å€‹å‡½å¼ä¾†å°å‡ºçµæœï¼Œç¢ºèªè³‡æ–™æ­£ç¢ºå¾Œæˆ‘å€‘æœƒå»ºç«‹æ–°çš„é é¢ä¾†é¡¯ç¤ºã€‚

ğŸ”§ æç¤ºï¼š

ä½ å¯ä»¥ä½¿ç”¨é¡ä¼¼ä¸‹é¢çš„ç¨‹å¼ç¢¼ä¾†é–‹å§‹æ’°å¯«ï¼š

from collections import defaultdict

def get_category_summary(records):
    summary = defaultdict(lambda: {"income": 0, "expense": 0})
    for record in records:
        if record.type == "income":
            summary[record.category]["income"] += record.amount
        elif record.type == "expense":
            summary[record.category]["expense"] += record.amount
    return dict(summary)

ğŸ” ä¸€ã€ä»€éº¼æ˜¯ defaultdict

defaultdict æ˜¯ Python çš„ä¸€ç¨®ç‰¹æ®Šå­—å…¸ï¼Œä¾†è‡ª collections æ¨¡çµ„ã€‚

è·Ÿæ™®é€šå­—å…¸ä¸åŒçš„æ˜¯ï¼š

    å¦‚æœä½ å­˜å–ä¸€å€‹ã€Œå°šæœªå‡ºç¾çš„ keyã€ï¼Œdefaultdict æœƒè‡ªå‹•å¹«ä½ å»ºç«‹é è¨­å€¼ã€‚

    ç”¨æ³•å¦‚ä¸‹ï¼š

    from collections import defaultdict

    d = defaultdict(int)
    d["a"] += 1   # è‡ªå‹•å»ºç«‹ d["a"] = 0ï¼Œå† +1 â†’ è®Šæˆ 1

ğŸ§  é€™ä¸€è¡Œçš„è§£é‡‹ï¼š

summary = defaultdict(lambda: {"income": 0, "expense": 0})

æ„æ€æ˜¯ï¼š

    å¦‚æœä½ ç”¨ä¸€å€‹å°šæœªå­˜åœ¨çš„é¡åˆ¥åç¨±ï¼ˆä¾‹å¦‚ "äº¤é€š"ï¼‰ä½œç‚º keyï¼Œé‚£å°±è‡ªå‹•å»ºç«‹ä¸€å€‹å­—å…¸ {"income": 0, "expense": 0} ä½œç‚ºå®ƒçš„åˆå§‹å€¼ã€‚

âœ… å¯¦éš›æ•ˆæœå¦‚ä¸‹ï¼š

summary["å¨›æ¨‚"]   â†’ {"income": 0, "expense": 0}ï¼ˆè‡ªå‹•å»ºç«‹ï¼‰

ğŸ§© summary[record.category]["income"] += record.amount çš„é‚è¼¯

é€™æ®µç¨‹å¼ç¢¼å¯ä»¥ç¿»è­¯æˆï¼š

    æ‰¾å‡ºé€™ç­†ç´€éŒ„çš„åˆ†é¡ï¼ˆå¦‚ "å¨›æ¨‚"ï¼‰ï¼Œå¦‚æœæ˜¯æ”¶å…¥ï¼Œå°±åŠ åˆ°è©²åˆ†é¡çš„ income æ•¸å­—ä¸Šã€‚

ä¾‹å­ï¼š

record.category == "å¨›æ¨‚"
record.type == "income"
record.amount == 2000

summary["å¨›æ¨‚"]["income"] += 2000

å› ç‚º summary["å¨›æ¨‚"] ä¸€é–‹å§‹æ˜¯ï¼š

{"income": 0, "expense": 0}

æ›´æ–°å¾Œè®Šæˆï¼š

{"income": 2000, "expense": 0}

ğŸ§¾ return dict(summary) çš„æ„æ€æ˜¯ä»€éº¼ï¼Ÿ

defaultdict æ˜¯ä¸€ç¨®ç‰¹æ®Šçš„è³‡æ–™å‹åˆ¥ï¼Œä½†ç‚ºäº†å›å‚³çµ¦å…¶ä»–å‡½å¼æˆ–æ¨¡æ¿ä½¿ç”¨æ™‚æ›´é€šç”¨ï¼Œæˆ‘å€‘ç”¨ï¼š

return dict(summary)

é€™æ¨£æœƒè½‰æˆæ™®é€šçš„ Python å­—å…¸ï¼Œåƒé€™æ¨£ï¼š

{
    "é¤é£²": {"income": 3000, "expense": 2500},
    "å¨›æ¨‚": {"income": 0, "expense": 1800},
}

âœ… ç¸½çµä½ å­¸åˆ°çš„
èªæ³•	åŠŸèƒ½èªªæ˜
defaultdict(lambda: {...})	è‡ªå‹•åˆå§‹åŒ–å­—å…¸çµæ§‹
summary[record.category]	ä»¥åˆ†é¡ç‚º key å­˜å–çµ±è¨ˆçµæœ
["income"] += ...	é‡å°æ”¶å…¥æ¬„ä½åŠ ç¸½
return dict(...)	å›å‚³ç‚ºæ™®é€šå­—å…¸ï¼Œé¿å…å¤–éƒ¨éŒ¯èª¤

ğŸ” ä¸€ã€defaultdict(lambda: {"income": 0, "expense": 0}) æ˜¯ä»€éº¼æ„æ€ï¼Ÿ

é€™æ˜¯ä¸€å€‹ç‰¹æ®Šçš„å­—å…¸çµæ§‹ï¼Œä¾†è‡ª collections æ¨¡çµ„ï¼š

from collections import defaultdict

summary = defaultdict(lambda: {"income": 0, "expense": 0})

âœ… åŠŸèƒ½ï¼š

å¦‚æœä½ ç”¨ summary["é¤é£²"]ï¼Œå®ƒæœƒè‡ªå‹•å»ºç«‹ä¸€å€‹ï¼š

{"income": 0, "expense": 0}

é€™æ¨£å°±ä¸ç”¨äº‹å…ˆæ‰‹å‹•å®£å‘Šæ¯å€‹åˆ†é¡ï¼Œéå¸¸æ–¹ä¾¿ï¼š

summary["é¤é£²"]["income"] += 200
summary["äº¤é€š"]["expense"] += 50

ğŸ” äºŒã€çµ±è¨ˆæ¯å€‹åˆ†é¡çš„é‡‘é¡

for record in records:
    summary[record.category][record.type] += record.amount

    record.category â†’ æ¯”å¦‚æ˜¯ "é¤é£²"

    record.type â†’ æ˜¯ "income" æˆ– "expense"

ç­‰æ–¼é€™æ¨£çš„æ•ˆæœï¼š

summary["é¤é£²"]["income"] += 500
summary["å¨›æ¨‚"]["expense"] += 300

ğŸ“Š ä¸‰ã€è¨ˆç®—å°è¨ˆèˆ‡æ”¯å‡ºæ¯”ä¾‹

total_sum = 0
for cat, values in summary.items():
    total = values["income"] + values["expense"]
    summary[cat]["total"] = total
    total_sum += total

é€™ä¸€æ®µåšå…©ä»¶äº‹ï¼š

    å¹«æ¯ä¸€å€‹åˆ†é¡åŠ ä¸Šä¸€å€‹ "total" æ¬„ä½ï¼ˆæ”¶å…¥ï¼‹æ”¯å‡ºï¼‰

    æŠŠæ‰€æœ‰åˆ†é¡çš„å°è¨ˆç›¸åŠ ï¼Œå¾—åˆ° total_sumï¼ˆæ•´é«”ç¸½é¡ï¼‰

ğŸ¯ å››ã€è¨ˆç®—æ¯å€‹åˆ†é¡çš„ä½”æ¯” %

for cat, values in summary.items():
    values["rate"] = round((values["total"] / total_sum * 100), 1) if total_sum > 0 else 0

    æ¯”å¦‚ é¤é£² total = 500ï¼Œtotal_sum = 2000

    é‚£å®ƒçš„å æ¯”å°±æ˜¯ 500 / 2000 * 100 = 25.0

ğŸ” æœ€å¾Œå›å‚³ä¸€å€‹æ™®é€šå­—å…¸

return dict(summary)

å› ç‚º defaultdict ä¸é©åˆç›´æ¥æ¸²æŸ“é€² HTMLï¼Œæ‰€ä»¥è½‰å›ä¸€èˆ¬å­—å…¸ã€‚
ğŸ§  ç¸½çµï¼šä½ æœƒæ‹¿åˆ°é€™æ¨£çš„çµæ§‹

{
  "é¤é£²": {"income": 300, "expense": 200, "total": 500, "rate": 25.0},
  "äº¤é€š": {"income": 0, "expense": 1000, "total": 1000, "rate": 50.0},
  ...
}

